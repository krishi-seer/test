<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8086 MUL Instruction - Execution Cycle</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@6.5.1/dist/framer-motion.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.3);
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8), 0 0 20px rgba(59, 130, 246, 0.6);
        }
        
        .gear {
            animation: spin 3s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8), 0 0 60px rgba(59, 130, 246, 0.6); }
        }
        
        .data-flow {
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: flow 2s infinite;
        }
        
        @keyframes flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(300%); }
        }
        
        .control-signal {
            background: linear-gradient(90deg, transparent, #ef4444, transparent);
            animation: control-flow 1.5s infinite;
        }
        
        @keyframes control-flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f0f 100%);
        }
        
        .flowing-arrow {
            position: relative;
            overflow: hidden;
        }
        
        .flowing-arrow::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), transparent);
            animation: arrow-flow 2s infinite;
        }
        
        @keyframes arrow-flow {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Add error handling to debug issues
        window.addEventListener('error', function(e) {
            console.error('Error:', e.error);
            document.body.innerHTML = '<div style="color: red; padding: 20px; font-family: monospace;">Error: ' + e.error.message + '</div>';
        });

        const { useState, useEffect } = React;
        const { motion, AnimatePresence } = window.Motion || window.FramerMotion || {};
        
        // Fallback if Framer Motion fails to load
        if (!motion) {
            console.warn('Framer Motion not loaded, using fallback');
            window.motion = {
                div: 'div',
                h1: 'h1',
                h2: 'h2',
                button: 'button'
            };
        }

        const Register = ({ label, value, highlight, position = {}, tooltip }) => {
            const [showTooltip, setShowTooltip] = useState(false);
            
            return (
                <div className="relative">
                    <motion.div
                        className={`bg-gray-800 border-2 rounded-lg p-4 text-center min-w-28 ${
                            highlight ? 'border-blue-400 neon-glow' : 'border-gray-600'
                        }`}
                        animate={position}
                        transition={{ type: 'spring', stiffness: 100, damping: 15 }}
                        onMouseEnter={() => setShowTooltip(true)}
                        onMouseLeave={() => setShowTooltip(false)}
                    >
                        <div className={`text-sm font-bold mb-2 ${
                            highlight ? 'text-blue-400 neon-text' : 'text-gray-300'
                        }`}>
                            {label}
                        </div>
                        <div className={`text-lg font-mono ${
                            highlight ? 'text-blue-300' : 'text-white'
                        }`}>
                            {value}
                        </div>
                    </motion.div>
                    
                    {showTooltip && tooltip && (
                        <motion.div
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-black border border-blue-400 rounded px-2 py-1 text-xs text-blue-300 whitespace-nowrap z-10"
                        >
                            {tooltip}
                        </motion.div>
                    )}
                </div>
            );
        };

        const MemoryCell = ({ address, instruction, highlight }) => (
            <motion.div
                className={`bg-gray-800 border-2 rounded-lg p-3 text-center ${
                    highlight ? 'border-blue-400 neon-glow' : 'border-gray-600'
                }`}
                animate={{ scale: highlight ? 1.1 : 1 }}
                transition={{ type: 'spring', stiffness: 200 }}
            >
                <div className="text-xs text-gray-400 mb-1">{address}</div>
                <div className={`text-sm font-mono ${
                    highlight ? 'text-blue-300 neon-text' : 'text-white'
                }`}>
                    {instruction}
                </div>
            </motion.div>
        );

        const ALU = ({ active, result, showCalculation }) => (
            <motion.div
                className={`relative bg-gradient-to-r from-gray-800 to-gray-700 border-2 rounded-xl p-6 text-center ${
                    active ? 'border-blue-400 neon-glow' : 'border-gray-600'
                }`}
                animate={{ scale: active ? 1.05 : 1 }}
                transition={{ type: 'spring', stiffness: 150 }}
            >
                <div className="text-lg font-bold text-blue-400 mb-3">ALU</div>
                {active && (
                    <>
                        <div className="gear text-4xl mb-3">‚öôÔ∏è</div>
                        {showCalculation && (
                            <motion.div
                                className="text-sm text-green-400 font-mono"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ delay: 1 }}
                            >
                                0x9000 √ó 0x0003 = {result}
                            </motion.div>
                        )}
                    </>
                )}
                {!active && <div className="text-2xl">‚öôÔ∏è</div>}
            </motion.div>
        );

        const ControlUnit = ({ active, signals }) => (
            <motion.div
                className={`bg-gray-800 border-2 rounded-lg p-4 text-center ${
                    active ? 'border-red-400 pulse-glow' : 'border-gray-600'
                }`}
                animate={{ scale: active ? 1.05 : 1 }}
            >
                <div className="text-md font-bold text-red-400 mb-2">Control Unit</div>
                {active && signals && (
                    <motion.div
                        className="text-xs text-red-300"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        transition={{ staggerChildren: 0.2 }}
                    >
                        {signals.map((signal, i) => (
                            <motion.div
                                key={i}
                                className="mb-1"
                                initial={{ x: -20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                transition={{ delay: i * 0.2 }}
                            >
                                {signal}
                            </motion.div>
                        ))}
                    </motion.div>
                )}
                {!active && <div className="text-lg">üéõÔ∏è</div>}
            </motion.div>
        );

        const FlowingArrow = ({ direction = "right", active, color = "blue" }) => {
            if (!active) return null;
            
            const colorClasses = {
                blue: "border-blue-400 text-blue-400",
                red: "border-red-400 text-red-400"
            };
            
            return (
                <motion.div
                    className={`flex items-center space-x-2 ${colorClasses[color]}`}
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.5 }}
                >
                    <div className={`h-0.5 bg-${color}-400 flex-1 flowing-arrow`}></div>
                    <span className="text-xl">
                        {direction === "right" ? "‚Üí" : direction === "left" ? "‚Üê" : direction === "down" ? "‚Üì" : "‚Üë"}
                    </span>
                </motion.div>
            );
        };

        const Flag = ({ label, value, active }) => (
            <motion.div
                className={`border rounded px-3 py-2 text-sm ${
                    active ? 'border-yellow-400 bg-yellow-900 text-yellow-300' : 'border-gray-600 text-gray-400'
                }`}
                animate={{ scale: active ? 1.1 : 1 }}
                transition={{ type: 'spring', stiffness: 200 }}
            >
                {label}: {value ? '1' : '0'}
            </motion.div>
        );

        const Timeline = ({ currentStage, stages }) => (
            <div className="flex items-center justify-center space-x-4 mb-8 overflow-x-auto">
                {stages.map((stage, index) => (
                    <React.Fragment key={stage}>
                        <motion.div
                            className={`px-3 py-2 rounded text-sm whitespace-nowrap ${
                                index === currentStage 
                                    ? 'bg-blue-600 text-white neon-glow' 
                                    : index < currentStage 
                                        ? 'bg-green-600 text-white' 
                                        : 'bg-gray-700 text-gray-400'
                            }`}
                            animate={{ scale: index === currentStage ? 1.1 : 1 }}
                        >
                            {stage}
                        </motion.div>
                        {index < stages.length - 1 && (
                            <div className={`w-8 h-0.5 ${
                                index < currentStage ? 'bg-green-400' : 'bg-gray-600'
                            }`}></div>
                        )}
                    </React.Fragment>
                ))}
            </div>
        );

        const InstructionRegister = ({ highlight, instruction }) => (
            <motion.div
                className={`bg-gray-800 border-2 rounded-lg p-3 text-center ${
                    highlight ? 'border-blue-400 neon-glow' : 'border-gray-600'
                }`}
                animate={{ scale: highlight ? 1.1 : 1 }}
            >
                <div className="text-sm font-bold text-blue-400 mb-2">IR</div>
                <div className={`text-sm font-mono ${
                    highlight ? 'text-blue-300 neon-text' : 'text-white'
                }`}>
                    {instruction || 'F7 E3'}
                </div>
            </motion.div>
        );

        const MULInstructionAnimation = () => {
            const [currentStage, setCurrentStage] = useState(-1); // -1 for intro
            const [autoPlay, setAutoPlay] = useState(false);
            const [registers, setRegisters] = useState({
                AX: '0x9000',
                BX: '0x0003',
                DX: '0x0000'
            });
            const [flags, setFlags] = useState({ CF: false, OF: false });
            
            const stages = [
                'Input', 'Fetch', 'Decode', 'Fetch Operands', 
                'Execute', 'Write Back', 'Update Flags', 'Complete'
            ];

            const stageData = {
                0: { // Input
                    title: 'Register Input',
                    description: 'Initial register values before multiplication',
                    highlightRegisters: ['AX', 'BX']
                },
                1: { // Fetch
                    title: 'Instruction Fetch',
                    description: 'CPU fetches MUL instruction from memory',
                    highlightMemory: true,
                    highlightIR: true,
                    showPC: true,
                    showMemoryArrow: true
                },
                2: { // Decode
                    title: 'Instruction Decode',
                    description: 'Control unit decodes opcode F7/4 and sets control signals',
                    activateControlUnit: true,
                    controlSignals: ['MUL_OP', 'REG_READ', 'ALU_EN'],
                    showControlArrow: true
                },
                3: { // Fetch Operands
                    title: 'Operand Fetch',
                    description: 'Move operands from registers to ALU',
                    highlightRegisters: ['AX', 'BX'],
                    showDataFlow: true,
                    showOperandArrows: true
                },
                4: { // Execute
                    title: 'Execute Multiplication',
                    description: 'ALU performs 16-bit multiplication',
                    activateALU: true,
                    showCalculation: true
                },
                5: { // Write Back
                    title: 'Write Back Results',
                    description: 'Store result in AX (low) and DX (high) registers',
                    highlightRegisters: ['AX', 'DX'],
                    updateResult: true,
                    showResultArrows: true
                },
                6: { // Update Flags
                    title: 'Update Status Flags',
                    description: 'Set Carry and Overflow flags based on result',
                    updateFlags: true,
                    highlightFlags: true
                },
                7: { // Complete
                    title: 'Execution Complete',
                    description: 'MUL instruction execution cycle finished',
                    showComplete: true
                }
            };

            useEffect(() => {
                if (autoPlay && currentStage < stages.length - 1) {
                    const timer = setTimeout(() => {
                        nextStage();
                    }, 3500);
                    return () => clearTimeout(timer);
                }
            }, [currentStage, autoPlay]);

            useEffect(() => {
                const stage = stageData[currentStage];
                if (stage?.updateResult) {
                    setTimeout(() => {
                        setRegisters(prev => ({
                            ...prev,
                            AX: '0xB200', // Low 16 bits
                            DX: '0x0001'  // High 16 bits
                        }));
                    }, 1000);
                }
                if (stage?.updateFlags) {
                    setTimeout(() => {
                        setFlags({ CF: false, OF: false }); // No overflow for this example
                    }, 500);
                }
            }, [currentStage]);

            const nextStage = () => {
                if (currentStage < stages.length - 1) {
                    setCurrentStage(prev => prev + 1);
                }
            };

            const prevStage = () => {
                if (currentStage > -1) {
                    setCurrentStage(prev => prev - 1);
                    // Reset registers if going back
                    if (currentStage <= 5) {
                        setRegisters({
                            AX: '0x9000',
                            BX: '0x0003',
                            DX: '0x0000'
                        });
                        setFlags({ CF: false, OF: false });
                    }
                }
            };

            const startAnimation = () => {
                setCurrentStage(0);
            };

            const resetAnimation = () => {
                setCurrentStage(-1);
                setAutoPlay(false);
                setRegisters({
                    AX: '0x9000',
                    BX: '0x0003',
                    DX: '0x0000'
                });
                setFlags({ CF: false, OF: false });
            };

            if (currentStage === -1) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <motion.div
                            className="text-center"
                            initial={{ opacity: 0, y: 50 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ duration: 1 }}
                        >
                            <motion.h1
                                className="text-6xl font-bold text-blue-400 neon-text mb-8"
                                animate={{ scale: [1, 1.05, 1] }}
                                transition={{ duration: 2, repeat: Infinity }}
                            >
                                8086 MUL Instruction
                            </motion.h1>
                            <motion.h2
                                className="text-3xl text-blue-300 mb-12"
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ delay: 0.5 }}
                            >
                                Execution Cycle Animation
                            </motion.h2>
                            <motion.button
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl neon-glow transition-all duration-300"
                                onClick={startAnimation}
                                whileHover={{ scale: 1.05 }}
                                whileTap={{ scale: 0.95 }}
                            >
                                Start Animation
                            </motion.button>
                        </motion.div>
                    </div>
                );
            }

            const currentStageData = stageData[currentStage] || {};

            return (
                <div className="min-h-screen p-4">
                    {/* Timeline */}
                    <Timeline currentStage={currentStage} stages={stages} />
                    
                    {/* Title and Description */}
                    <motion.div
                        className="text-center mb-8"
                        key={currentStage}
                        initial={{ opacity: 0, y: -20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.5 }}
                    >
                        <h2 className="text-3xl font-bold text-blue-400 neon-text mb-4">
                            {currentStageData.title}
                        </h2>
                        <p className="text-lg text-gray-300">
                            {currentStageData.description}
                        </p>
                    </motion.div>

                    {/* Main Animation Area */}
                    <div className="max-w-7xl mx-auto">
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                            {/* Left Column - Memory and PC */}
                            <div className="space-y-6">
                                {currentStage >= 1 && (
                                    <motion.div
                                        className="text-center"
                                        initial={{ opacity: 0, x: -50 }}
                                        animate={{ opacity: 1, x: 0 }}
                                    >
                                        <h3 className="text-lg font-bold text-blue-400 mb-4">Memory</h3>
                                        <MemoryCell
                                            address="1000h"
                                            instruction="F7 E3 (MUL BX)"
                                            highlight={currentStageData.highlightMemory}
                                        />
                                        {currentStageData.showPC && (
                                            <motion.div
                                                className="mt-2 text-sm text-yellow-400"
                                                initial={{ opacity: 0 }}
                                                animate={{ opacity: 1 }}
                                            >
                                                ‚Üê PC: 1000h
                                            </motion.div>
                                        )}
                                        
                                        {currentStageData.showMemoryArrow && (
                                            <div className="mt-4">
                                                <FlowingArrow direction="down" active={true} />
                                            </div>
                                        )}
                                        
                                        {currentStage >= 1 && (
                                            <div className="mt-4">
                                                <h4 className="text-md font-bold text-blue-400 mb-2">IR</h4>
                                                <InstructionRegister
                                                    highlight={currentStageData.highlightIR}
                                                    instruction="F7 E3"
                                                />
                                            </div>
                                        )}
                                    </motion.div>
                                )}
                            </div>

                            {/* Second Column - Registers */}
                            <div className="space-y-6">
                                <div className="text-center">
                                    <h3 className="text-lg font-bold text-blue-400 mb-4">Registers</h3>
                                    <div className="space-y-4">
                                        <Register
                                            label="AX"
                                            value={registers.AX}
                                            highlight={currentStageData.highlightRegisters?.includes('AX')}
                                            tooltip="Accumulator Register - stores multiplicand and low result"
                                        />
                                        <Register
                                            label="BX"
                                            value={registers.BX}
                                            highlight={currentStageData.highlightRegisters?.includes('BX')}
                                            tooltip="Base Register - stores multiplier"
                                        />
                                        <Register
                                            label="DX"
                                            value={registers.DX}
                                            highlight={currentStageData.highlightRegisters?.includes('DX')}
                                            tooltip="Data Register - stores high result"
                                        />
                                    </div>
                                    
                                    {currentStageData.showOperandArrows && (
                                        <div className="mt-4 space-y-2">
                                            <FlowingArrow direction="right" active={true} />
                                            <div className="text-xs text-blue-300">Operands to ALU</div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Third Column - Control Unit and ALU */}
                            <div className="space-y-6">
                                {currentStage >= 2 && (
                                    <motion.div
                                        initial={{ opacity: 0, y: -30 }}
                                        animate={{ opacity: 1, y: 0 }}
                                    >
                                        <ControlUnit
                                            active={currentStageData.activateControlUnit}
                                            signals={currentStageData.controlSignals}
                                        />
                                        {currentStageData.showControlArrow && (
                                            <div className="mt-2">
                                                <FlowingArrow direction="down" active={true} color="red" />
                                            </div>
                                        )}
                                    </motion.div>
                                )}
                                
                                {currentStage >= 4 && (
                                    <motion.div
                                        initial={{ opacity: 0, scale: 0.8 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        transition={{ delay: 0.3 }}
                                    >
                                        <ALU
                                            active={currentStageData.activateALU}
                                            result="0x1B200"
                                            showCalculation={currentStageData.showCalculation}
                                        />
                                        
                                        {currentStageData.showResultArrows && (
                                            <div className="mt-4">
                                                <FlowingArrow direction="left" active={true} />
                                                <div className="text-xs text-blue-300 mt-1">Results to Registers</div>
                                            </div>
                                        )}
                                    </motion.div>
                                )}
                                
                                {currentStageData.showCalculation && (
                                    <motion.div
                                        className="text-center bg-gray-800 border border-green-400 rounded-lg p-4"
                                        initial={{ opacity: 0, scale: 0.8 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        transition={{ delay: 1 }}
                                    >
                                        <div className="text-green-400 font-mono text-lg">
                                            36864 √ó 3 = 110592
                                        </div>
                                        <div className="text-green-300 text-sm mt-2">
                                            (0x9000 √ó 0x0003 = 0x1B200)
                                        </div>
                                        <div className="text-blue-300 text-xs mt-2">
                                            DX:AX = 0x0001:0xB200
                                        </div>
                                    </motion.div>
                                )}
                            </div>

                            {/* Right Column - Status and Flags */}
                            <div className="space-y-6">
                                {currentStage >= 6 && (
                                    <motion.div
                                        className="text-center"
                                        initial={{ opacity: 0, x: 50 }}
                                        animate={{ opacity: 1, x: 0 }}
                                    >
                                        <h3 className="text-lg font-bold text-blue-400 mb-4">Status Flags</h3>
                                        <div className="space-y-3">
                                            <Flag
                                                label="CF (Carry)"
                                                value={flags.CF}
                                                active={currentStageData.highlightFlags}
                                            />
                                            <Flag
                                                label="OF (Overflow)"
                                                value={flags.OF}
                                                active={currentStageData.highlightFlags}
                                            />
                                        </div>
                                        <div className="text-xs text-gray-400 mt-3">
                                            CF=0, OF=0: Result fits in 16 bits
                                        </div>
                                    </motion.div>
                                )}
                                
                                {currentStage === 7 && (
                                    <motion.div
                                        className="bg-green-900 border border-green-400 rounded-lg p-4 text-center"
                                        initial={{ opacity: 0, scale: 0.8 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        transition={{ delay: 0.5 }}
                                    >
                                        <div className="text-green-400 font-bold text-lg mb-2">
                                            ‚úÖ Complete!
                                        </div>
                                        <div className="text-green-300 text-sm">
                                            Final Result: DX:AX = 0x0001:0xB200
                                        </div>
                                        <div className="text-green-200 text-xs mt-2">
                                            110592 decimal = 0x1B200 hex
                                        </div>
                                    </motion.div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Controls */}
                    <motion.div
                        className="fixed bottom-6 left-1/2 transform -translate-x-1/2 flex flex-wrap justify-center space-x-2 space-y-2 bg-black bg-opacity-80 p-4 rounded-lg"
                        initial={{ opacity: 0, y: 50 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 1 }}
                    >
                        <button
                            className="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 mt-2"
                            onClick={prevStage}
                            disabled={currentStage <= 0}
                        >
                            ‚Üê Previous
                        </button>
                        
                        <button
                            className={`font-bold py-2 px-4 rounded mt-2 ${
                                autoPlay 
                                    ? 'bg-red-600 hover:bg-red-700 text-white' 
                                    : 'bg-green-600 hover:bg-green-700 text-white'
                            }`}
                            onClick={() => setAutoPlay(!autoPlay)}
                        >
                            {autoPlay ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Auto Play'}
                        </button>
                        
                        <button
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 mt-2"
                            onClick={nextStage}
                            disabled={currentStage >= stages.length - 1}
                        >
                            Next ‚Üí
                        </button>
                        
                        <button
                            className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded mt-2"
                            onClick={resetAnimation}
                        >
                            üîÑ Reset
                        </button>
                    </motion.div>
                </div>
            );
        };

        ReactDOM.render(<MULInstructionAnimation />, document.getElementById('root'));
    </script>
</body>
</html>