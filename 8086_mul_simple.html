<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8086 MUL Instruction - Execution Cycle</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Orbitron', monospace;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f0f 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .main-content {
            margin-left: 180px;
            transition: margin-left 0.3s ease;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 170px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            border-right: 2px solid #3b82f6;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .sidebar-button {
            width: 140px;
            margin-bottom: 12px;
            font-size: 14px;
            padding: 10px 8px;
            text-align: center;
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8), 0 0 20px rgba(59, 130, 246, 0.6);
            color: #60a5fa;
        }
        
        .gear {
            animation: spin 3s linear infinite;
            font-size: 3rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8), 0 0 60px rgba(239, 68, 68, 0.6); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .scale-in {
            animation: scaleIn 0.5s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .flowing-arrow {
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: flow 2s infinite;
        }
        
        @keyframes flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Register = ({ label, value, highlight, tooltip }) => {
            const [showTooltip, setShowTooltip] = useState(false);
            
            return (
                <div className="relative">
                    <div
                        className={`bg-gray-800 border-2 rounded-lg p-4 text-center min-w-28 transition-all duration-300 ${
                            highlight ? 'neon-glow' : 'border-gray-600'
                        }`}
                        onMouseEnter={() => setShowTooltip(true)}
                        onMouseLeave={() => setShowTooltip(false)}
                    >
                        <div className={`text-sm font-bold mb-2 ${
                            highlight ? 'neon-text' : 'text-gray-300'
                        }`}>
                            {label}
                        </div>
                        <div className={`text-lg font-mono ${
                            highlight ? 'text-blue-300' : 'text-white'
                        }`}>
                            {value}
                        </div>
                    </div>
                    
                    {showTooltip && tooltip && (
                        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-black border border-blue-400 rounded px-2 py-1 text-xs text-blue-300 whitespace-nowrap z-10 fade-in">
                            {tooltip}
                        </div>
                    )}
                </div>
            );
        };

        const MemoryCell = ({ address, instruction, highlight }) => (
            <div className={`bg-gray-800 border-2 rounded-lg p-3 text-center transition-all duration-300 ${
                highlight ? 'neon-glow scale-110' : 'border-gray-600'
            }`}>
                <div className="text-xs text-gray-400 mb-1">{address}</div>
                <div className={`text-sm font-mono ${
                    highlight ? 'neon-text' : 'text-white'
                }`}>
                    {instruction}
                </div>
            </div>
        );

        const ALU = ({ active, result, showCalculation }) => (
            <div className={`relative bg-gradient-to-r from-gray-800 to-gray-700 border-2 rounded-xl p-6 text-center transition-all duration-300 ${
                active ? 'neon-glow scale-105' : 'border-gray-600'
            }`}>
                <div className="text-lg font-bold text-blue-400 mb-3">ALU</div>
                {active && (
                    <>
                        <div className="gear text-blue-400">‚öôÔ∏è</div>
                        {showCalculation && (
                            <div className="text-sm text-green-400 font-mono mt-2 fade-in">
                                0x9000 √ó 0x0003 = {result}
                            </div>
                        )}
                    </>
                )}
                {!active && <div className="text-2xl text-gray-400">‚öôÔ∏è</div>}
            </div>
        );

        const ControlUnit = ({ active, signals }) => (
            <div className={`bg-gray-800 border-2 rounded-lg p-4 text-center transition-all duration-300 ${
                active ? 'border-red-400 pulse-glow scale-105' : 'border-gray-600'
            }`}>
                <div className="text-md font-bold text-red-400 mb-2">Control Unit</div>
                {active && signals ? (
                    <div className="text-xs text-red-300 fade-in">
                        {signals.map((signal, i) => (
                            <div key={i} className="mb-1" style={{animationDelay: `${i * 0.2}s`}}>
                                {signal}
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-lg">üéõÔ∏è</div>
                )}
            </div>
        );

        const Flag = ({ label, value, active }) => (
            <div className={`border rounded px-3 py-2 text-sm transition-all duration-300 ${
                active ? 'border-yellow-400 bg-yellow-900 text-yellow-300 scale-110' : 'border-gray-600 text-gray-400'
            }`}>
                {label}: {value ? '1' : '0'}
            </div>
        );

        const Timeline = ({ currentStage, stages }) => (
            <div className="flex items-center justify-center space-x-4 mb-8 overflow-x-auto">
                {stages.map((stage, index) => (
                    <React.Fragment key={stage}>
                        <div className={`px-3 py-2 rounded text-sm whitespace-nowrap transition-all duration-300 ${
                            index === currentStage 
                                ? 'bg-blue-600 text-white neon-glow scale-110' 
                                : index < currentStage 
                                    ? 'bg-green-600 text-white' 
                                    : 'bg-gray-700 text-gray-400'
                        }`}>
                            {stage}
                        </div>
                        {index < stages.length - 1 && (
                            <div className={`w-8 h-0.5 transition-all duration-300 ${
                                index < currentStage ? 'bg-green-400' : 'bg-gray-600'
                            }`}></div>
                        )}
                    </React.Fragment>
                ))}
            </div>
        );

        const InstructionRegister = ({ highlight, instruction }) => (
            <div className={`bg-gray-800 border-2 rounded-lg p-3 text-center transition-all duration-300 ${
                highlight ? 'neon-glow scale-110' : 'border-gray-600'
            }`}>
                <div className="text-sm font-bold text-blue-400 mb-2">IR</div>
                <div className={`text-sm font-mono ${
                    highlight ? 'neon-text' : 'text-white'
                }`}>
                    {instruction || 'F7 E3'}
                </div>
            </div>
        );

        const MULInstructionAnimation = () => {
            const [currentStage, setCurrentStage] = useState(-1);
            const [autoPlay, setAutoPlay] = useState(false);
            const [userAX, setUserAX] = useState('0x9000');
            const [userBX, setUserBX] = useState('0x0003');
            const [registers, setRegisters] = useState({
                AX: '0x9000',
                BX: '0x0003',
                DX: '0x0000'
            });
            const [flags, setFlags] = useState({ CF: false, OF: false });
            const [showInputModal, setShowInputModal] = useState(false);
            
            const stages = [
                'Input', 'Fetch', 'Decode', 'Fetch Operands', 
                'Execute', 'Write Back', 'Update Flags', 'Complete'
            ];

            // Calculate the actual result based on user inputs
            const calculateResult = () => {
                const axValue = parseInt(userAX, 16) || parseInt(userAX, 10) || 0;
                const bxValue = parseInt(userBX, 16) || parseInt(userBX, 10) || 0;
                const result = axValue * bxValue;
                const highResult = Math.floor(result / 65536);
                const lowResult = result % 65536;
                
                return {
                    full: result,
                    high: `0x${highResult.toString(16).toUpperCase().padStart(4, '0')}`,
                    low: `0x${lowResult.toString(16).toUpperCase().padStart(4, '0')}`,
                    decimal: result,
                    overflow: result > 65535
                };
            };

            const stageData = {
                0: { title: 'Register Input', description: 'Initial register values before multiplication', highlightRegisters: ['AX', 'BX'] },
                1: { title: 'Instruction Fetch', description: 'CPU fetches MUL instruction from memory', highlightMemory: true, highlightIR: true, showPC: true },
                2: { title: 'Instruction Decode', description: 'Control unit decodes opcode F7/4 and sets control signals', activateControlUnit: true, controlSignals: ['MUL_OP', 'REG_READ', 'ALU_EN'] },
                3: { title: 'Operand Fetch', description: 'Move operands from registers to ALU', highlightRegisters: ['AX', 'BX'] },
                4: { title: 'Execute Multiplication', description: 'ALU performs 16-bit multiplication', activateALU: true, showCalculation: true },
                5: { title: 'Write Back Results', description: 'Store result in AX (low) and DX (high) registers', highlightRegisters: ['AX', 'DX'], updateResult: true },
                6: { title: 'Update Status Flags', description: 'Set Carry and Overflow flags based on result', updateFlags: true, highlightFlags: true },
                7: { title: 'Execution Complete', description: 'MUL instruction execution cycle finished', showComplete: true }
            };

            useEffect(() => {
                if (autoPlay && currentStage < stages.length - 1) {
                    const timer = setTimeout(() => {
                        nextStage();
                    }, 3500);
                    return () => clearTimeout(timer);
                }
            }, [currentStage, autoPlay]);

            useEffect(() => {
                const stage = stageData[currentStage];
                if (stage?.updateResult) {
                    setTimeout(() => {
                        const result = calculateResult();
                        setRegisters(prev => ({
                            ...prev,
                            AX: result.low,
                            DX: result.high
                        }));
                    }, 1000);
                }
                if (stage?.updateFlags) {
                    setTimeout(() => {
                        const result = calculateResult();
                        setFlags({ CF: result.overflow, OF: result.overflow });
                    }, 500);
                }
            }, [currentStage, userAX, userBX]);

            const nextStage = () => {
                if (currentStage < stages.length - 1) {
                    setCurrentStage(prev => prev + 1);
                }
            };

            const prevStage = () => {
                if (currentStage > -1) {
                    setCurrentStage(prev => prev - 1);
                    if (currentStage <= 5) {
                        setRegisters({ AX: '0x9000', BX: '0x0003', DX: '0x0000' });
                        setFlags({ CF: false, OF: false });
                    }
                }
            };

            const startAnimation = () => {
                // Update registers with user values before starting
                setRegisters({
                    AX: userAX,
                    BX: userBX,
                    DX: '0x0000'
                });
                setCurrentStage(0);
                setShowInputModal(false);
            };

            const resetAnimation = () => {
                setCurrentStage(-1);
                setAutoPlay(false);
                setRegisters({ AX: userAX, BX: userBX, DX: '0x0000' });
                setFlags({ CF: false, OF: false });
            };

            const handleInputSubmit = () => {
                // Validate inputs
                const axValue = parseInt(userAX, 16) || parseInt(userAX, 10);
                const bxValue = parseInt(userBX, 16) || parseInt(userBX, 10);
                
                if (isNaN(axValue) || isNaN(bxValue) || axValue < 0 || bxValue < 0 || axValue > 65535 || bxValue > 65535) {
                    alert('Please enter valid 16-bit values (0-65535 or 0x0000-0xFFFF)');
                    return;
                }
                
                // Format inputs as hex
                setUserAX(`0x${axValue.toString(16).toUpperCase().padStart(4, '0')}`);
                setUserBX(`0x${bxValue.toString(16).toUpperCase().padStart(4, '0')}`);
                
                startAnimation();
            };

            if (currentStage === -1) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center scale-in">
                            <h1 className="text-6xl font-bold neon-text mb-8">
                                8086 MUL Instruction
                            </h1>
                            <h2 className="text-3xl text-blue-300 mb-12 fade-in" style={{animationDelay: '0.5s'}}>
                                Execution Cycle Animation
                            </h2>
                            
                            {/* Input Form */}
                            <div className="bg-gray-800 border border-blue-400 rounded-lg p-6 mb-8 max-w-md mx-auto">
                                <h3 className="text-xl text-blue-400 mb-4">Enter Register Values</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-2">AX Register (Multiplicand):</label>
                                        <input
                                            type="text"
                                            value={userAX}
                                            onChange={(e) => setUserAX(e.target.value)}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white font-mono"
                                            placeholder="0x9000 or 36864"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-300 mb-2">BX Register (Multiplier):</label>
                                        <input
                                            type="text"
                                            value={userBX}
                                            onChange={(e) => setUserBX(e.target.value)}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white font-mono"
                                            placeholder="0x0003 or 3"
                                        />
                                    </div>
                                    <div className="text-xs text-gray-400">
                                        Enter values in hex (0x1234) or decimal (4660). Max: 65535 (0xFFFF)
                                    </div>
                                </div>
                            </div>
                            
                            <button
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl neon-glow transition-all duration-300 hover:scale-105"
                                onClick={handleInputSubmit}
                            >
                                Start Animation
                            </button>
                        </div>
                    </div>
                );
            }

            const currentStageData = stageData[currentStage] || {};

            return (
                <React.Fragment>
                    {/* Vertical Sidebar */}
                    <div className="sidebar">
                        <button
                            className="sidebar-button bg-gray-700 hover:bg-gray-600 text-white font-bold rounded disabled:opacity-50 transition-all duration-300"
                            onClick={prevStage}
                            disabled={currentStage <= 0}
                        >
                            ‚Üê Previous
                        </button>
                        
                        <button
                            className={`sidebar-button font-bold rounded transition-all duration-300 ${
                                autoPlay 
                                    ? 'bg-red-600 hover:bg-red-700 text-white' 
                                    : 'bg-green-600 hover:bg-green-700 text-white'
                            }`}
                            onClick={() => setAutoPlay(!autoPlay)}
                        >
                            {autoPlay ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Auto Play'}
                        </button>
                        
                        <button
                            className="sidebar-button bg-blue-600 hover:bg-blue-700 text-white font-bold rounded disabled:opacity-50 transition-all duration-300"
                            onClick={nextStage}
                            disabled={currentStage >= stages.length - 1}
                        >
                            Next ‚Üí
                        </button>
                        
                        <button
                            className="sidebar-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded transition-all duration-300"
                            onClick={resetAnimation}
                        >
                            üîÑ Reset
                        </button>
                        
                        <div className="mt-6 text-center">
                            <div className="text-xs text-gray-400 mb-2">Current Values:</div>
                            <div className="text-xs text-blue-300 font-mono">
                                AX: {userAX}<br/>
                                BX: {userBX}
                            </div>
                        </div>
                    </div>
                    
                    <div className="main-content min-h-screen p-4">
                        <Timeline currentStage={currentStage} stages={stages} />
                        
                        <div className="text-center mb-8 fade-in">
                            <h2 className="text-3xl font-bold neon-text mb-4">
                                {currentStageData.title}
                            </h2>
                            <p className="text-lg text-gray-300">
                                {currentStageData.description}
                            </p>
                        </div>

                    <div className="max-w-7xl mx-auto">
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                            {/* Memory and PC */}
                            <div className="space-y-6">
                                {currentStage >= 1 && (
                                    <div className="text-center slide-in-left">
                                        <h3 className="text-lg font-bold text-blue-400 mb-4">Memory</h3>
                                        <MemoryCell
                                            address="1000h"
                                            instruction="F7 E3 (MUL BX)"
                                            highlight={currentStageData.highlightMemory}
                                        />
                                        {currentStageData.showPC && (
                                            <div className="mt-2 text-sm text-yellow-400 fade-in">
                                                ‚Üê PC: 1000h
                                            </div>
                                        )}
                                        
                                        {currentStage >= 1 && (
                                            <div className="mt-4">
                                                <h4 className="text-md font-bold text-blue-400 mb-2">IR</h4>
                                                <InstructionRegister
                                                    highlight={currentStageData.highlightIR}
                                                    instruction="F7 E3"
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Registers */}
                            <div className="space-y-6">
                                <div className="text-center">
                                    <h3 className="text-lg font-bold text-blue-400 mb-4">Registers</h3>
                                    <div className="space-y-4">
                                        <Register
                                            label="AX"
                                            value={registers.AX}
                                            highlight={currentStageData.highlightRegisters?.includes('AX')}
                                            tooltip="Accumulator Register - stores multiplicand and low result"
                                        />
                                        <Register
                                            label="BX"
                                            value={registers.BX}
                                            highlight={currentStageData.highlightRegisters?.includes('BX')}
                                            tooltip="Base Register - stores multiplier"
                                        />
                                        <Register
                                            label="DX"
                                            value={registers.DX}
                                            highlight={currentStageData.highlightRegisters?.includes('DX')}
                                            tooltip="Data Register - stores high result"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Control Unit and ALU */}
                            <div className="space-y-6">
                                {currentStage >= 2 && (
                                    <div className="fade-in">
                                        <ControlUnit
                                            active={currentStageData.activateControlUnit}
                                            signals={currentStageData.controlSignals}
                                        />
                                    </div>
                                )}
                                
                                {currentStage >= 4 && (
                                    <div className="scale-in">
                                        <ALU
                                            active={currentStageData.activateALU}
                                            result="0x1B200"
                                            showCalculation={currentStageData.showCalculation}
                                        />
                                        
                                        {currentStageData.showCalculation && (() => {
                                            const result = calculateResult();
                                            return (
                                                <div className="text-center bg-gray-800 border border-green-400 rounded-lg p-4 mt-4 fade-in">
                                                    <div className="text-green-400 font-mono text-lg">
                                                        {parseInt(userAX, 16) || parseInt(userAX, 10) || 0} √ó {parseInt(userBX, 16) || parseInt(userBX, 10) || 0} = {result.decimal}
                                                    </div>
                                                    <div className="text-green-300 text-sm mt-2">
                                                        ({userAX} √ó {userBX} = 0x{result.full.toString(16).toUpperCase().padStart(8, '0')})
                                                    </div>
                                                    <div className="text-blue-300 text-xs mt-2">
                                                        DX:AX = {result.high}:{result.low}
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>

                            {/* Status Flags */}
                            <div className="space-y-6">
                                {currentStage >= 6 && (
                                    <div className="text-center slide-in-right">
                                        <h3 className="text-lg font-bold text-blue-400 mb-4">Status Flags</h3>
                                        <div className="space-y-3">
                                            <Flag
                                                label="CF (Carry)"
                                                value={flags.CF}
                                                active={currentStageData.highlightFlags}
                                            />
                                            <Flag
                                                label="OF (Overflow)"
                                                value={flags.OF}
                                                active={currentStageData.highlightFlags}
                                            />
                                        </div>
                                        <div className="text-xs text-gray-400 mt-3">
                                            {(() => {
                                                const result = calculateResult();
                                                return result.overflow ? 'CF=1, OF=1: Result exceeds 16 bits' : 'CF=0, OF=0: Result fits in 16 bits';
                                            })()}
                                        </div>
                                    </div>
                                )}
                                
                                {currentStage === 7 && (
                                    <div className="bg-green-900 border border-green-400 rounded-lg p-4 text-center scale-in">
                                        <div className="text-green-400 font-bold text-lg mb-2">
                                            ‚úÖ Complete!
                                        </div>
                                        {(() => {
                                            const result = calculateResult();
                                            return (
                                                <>
                                                    <div className="text-green-300 text-sm">
                                                        Final Result: DX:AX = {result.high}:{result.low}
                                                    </div>
                                                    <div className="text-green-200 text-xs mt-2">
                                                        {result.decimal} decimal = 0x{result.full.toString(16).toUpperCase()} hex
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    </div>
                </React.Fragment>
            );
        };

        // Render the app
        try {
            ReactDOM.render(<MULInstructionAnimation />, document.getElementById('root'));
        } catch (error) {
            console.error('Error rendering app:', error);
            document.getElementById('root').innerHTML = `
                <div style="color: red; padding: 20px; font-family: monospace;">
                    <h2>Animation Loading Error</h2>
                    <p>Error: ${error.message}</p>
                    <p>Please refresh the page or check the browser console for more details.</p>
                </div>
            `;
        }
    </script>
</body>
</html>